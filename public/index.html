<!DOCTYPE html>
<html>
<head>
  <title>SIP Chat Interface</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
      min-height: 100vh;
      box-sizing: border-box;
    }
    
    #chat {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      height: calc(100vh - 40px); /* Full height minus body padding */
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    
    h1 {
      margin-top: 0;
      margin-bottom: 20px;
    }
    
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #eee;
      border-radius: 4px;
      min-height: 0; /* Important for flex scrolling */
    }
    
    .message {
      max-width: 70%;
      margin: 10px 0;
      padding: 12px;
      border-radius: 8px;
      line-height: 1.4;
    }
    
    .user-message {
      background: #1976d2;
      color: white;
      margin-left: auto;
      margin-right: 0;
    }
    
    .bot-message {
      background: #f5f5f5;
      color: #333;
      margin-right: auto;
      margin-left: 0;
    }
    
    #input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      width: 100%;
      align-items: flex-start;
    }
    
    #input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      font-family: inherit;
      resize: none;
      min-height: 40px;
      max-height: 200px;
      overflow-y: auto;
      line-height: 1.4;
      margin: 0; /* Remove any default margins */
    }
    
    button {
      padding: 10px 20px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      white-space: nowrap; /* Prevent button text from wrapping */
      height: 40px; /* Match input height */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    button:hover {
      background: #1565c0;
    }
    
    .loading {
      display: inline-block;
      margin-left: 10px;
    }
    
    .loading:after {
      content: '.';
      animation: dots 1.5s steps(5, end) infinite;
    }
    
    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60% { content: '...'; }
      80%, 100% { content: ''; }
    }
    
    .thinking {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #666;
    }

    .thinking-dots {
      display: flex;
      gap: 4px;
    }

    .thinking-dots span {
      width: 8px;
      height: 8px;
      background: #1976d2;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
    .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .thinking-timer {
      margin-left: 8px;
      font-family: monospace;
    }

    .bot-error {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef9a9a;
    }

    pre[class*="language-"] {
      position: relative;
      border-radius: 6px;
      margin: 1em 0;
    }

    .copy-button {
      position: absolute;
      top: 5px;
      right: 5px;
      padding: 4px 8px;
      font-size: 12px;
      background: #2d2d2d;
      border: 1px solid #444;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.2s;
    }

    pre[class*="language-"]:hover .copy-button {
      opacity: 1;
    }

    .copy-button:hover {
      background: #444;
    }

    .copy-button.copied {
      background: #4CAF50;
    }

    #chat-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }
    
    #chat-controls button {
      flex: 1;
      min-width: fit-content; /* Prevent buttons from getting too narrow */
      white-space: nowrap;
    }

    /* Make all buttons in a row have equal width */
    @media (min-width: 768px) {
      #chat-controls {
        flex-wrap: nowrap;
      }
      
      #chat-controls button {
        flex: 1;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markdown.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
</head>
<body>
  <div id="chat">
    <h1>SIP Chat Assistant</h1>
    <div id="messages"></div>
    <div id="input-area">
      <textarea 
        id="input" 
        placeholder="Ask about SuperRare Improvement Proposals..."
        rows="1"
      ></textarea>
      <button onclick="sendMessage()">Send</button>
    </div>
    <div id="chat-controls">
      <button onclick="exportHistory()">Export Chat History</button>
      <button onclick="enforceSectionHeaders()">Enforce Section Headers</button>
      <button onclick="askForPrettyText()">Ask for Pretty Text</button>
      <button onclick="askForMarkdown()">Ask for Markdown</button>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById('messages');
    const inputField = document.getElementById('input');

    // Add initial message
    addMessage('Welcome! Ask me anything about SuperRare Improvement Proposals.', 'bot');

    let chatHistory = [];

    function saveToHistory(message, type) {
      chatHistory.push({ message, type, timestamp: new Date() });
      localStorage.setItem('sipChatHistory', JSON.stringify(chatHistory));
    }

    function addThinkingMessage() {
      const thinkingDiv = document.createElement('div');
      thinkingDiv.className = 'message bot-message thinking';
      
      // Add animated dots
      const dotsDiv = document.createElement('div');
      dotsDiv.className = 'thinking-dots';
      dotsDiv.innerHTML = '<span></span><span></span><span></span>';
      
      // Add timer
      const timerDiv = document.createElement('div');
      timerDiv.className = 'thinking-timer';
      
      let seconds = 0;
      const timer = setInterval(() => {
        seconds++;
        timerDiv.textContent = `${seconds}s`;
      }, 1000);
      
      thinkingDiv.appendChild(document.createTextNode('Thinking'));
      thinkingDiv.appendChild(dotsDiv);
      thinkingDiv.appendChild(timerDiv);
      messagesDiv.appendChild(thinkingDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      
      return { div: thinkingDiv, timer };
    }

    // Generate a random session ID when the page loads
    const sessionId = Math.random().toString(36).substring(7);

    async function sendMessage() {
      const message = inputField.value.trim();
      if (!message) return;

      // Add user message
      addMessage(message, 'user');
      inputField.value = '';
      saveToHistory(message, 'user'); // Save user message too

      // Disable input while processing
      inputField.disabled = true;
      const { div: thinkingDiv, timer } = addThinkingMessage();

      try {
        const response = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            message: message,
            sessionId: sessionId
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.userMessage || data.error || 'Unknown error occurred');
        }

        clearInterval(timer); // Stop the timer
        messagesDiv.removeChild(thinkingDiv);
        addMessage(data.response, 'bot');
        saveToHistory(data.response, 'bot');
      } catch (error) {
        console.error('Chat error:', error);
        clearInterval(timer); // Stop the timer
        messagesDiv.removeChild(thinkingDiv);
        addMessage(error.message, 'bot-error');
      } finally {
        inputField.disabled = false;
        inputField.focus();
      }
    }

    function addMessage(text, type) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}-message`;
      
      if (type === 'bot') {
        // Parse markdown with marked
        const html = marked.parse(text);
        messageDiv.innerHTML = html;
        
        // Add copy buttons to code blocks and apply syntax highlighting
        messageDiv.querySelectorAll('pre code').forEach(block => {
          // Get the language from the class if it exists
          const language = block.className.match(/language-(\w+)/)?.[1] || 'markdown';
          
          // Create wrapper pre element with proper Prism classes
          const pre = document.createElement('pre');
          pre.className = `language-${language}`;
          
          // Create copy button
          const copyButton = document.createElement('button');
          copyButton.className = 'copy-button';
          copyButton.textContent = 'Copy';
          copyButton.onclick = async () => {
            try {
              await navigator.clipboard.writeText(block.textContent);
              copyButton.textContent = 'Copied!';
              copyButton.classList.add('copied');
              setTimeout(() => {
                copyButton.textContent = 'Copy';
                copyButton.classList.remove('copied');
              }, 2000);
            } catch (err) {
              console.error('Failed to copy:', err);
            }
          };
          
          // Set up the structure
          pre.appendChild(copyButton);
          block.parentNode.replaceChild(pre, block);
          pre.appendChild(block);
          
          // Apply Prism highlighting
          Prism.highlightElement(block);
        });
      } else {
        messageDiv.textContent = text;
      }
      
      messagesDiv.appendChild(messageDiv);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Replace the existing keypress handler with this
    inputField.addEventListener('keydown', (e) => {
      // Auto-resize the textarea
      inputField.style.height = 'auto';
      inputField.style.height = inputField.scrollHeight + 'px';
      
      if (e.key === 'Enter') {
        if (e.shiftKey) {
          // Allow new line with Shift+Enter
          return;
        } else {
          // Send message on Enter without shift
          e.preventDefault();
          sendMessage();
        }
      }
    });

    // Add an input event listener for handling pasted text and other changes
    inputField.addEventListener('input', () => {
      inputField.style.height = 'auto';
      inputField.style.height = inputField.scrollHeight + 'px';
    });

    function exportHistory() {
      const historyText = chatHistory
        .map(h => `[${h.timestamp}] ${h.type}: ${h.message}`)
        .join('\n\n');
        
      const blob = new Blob([historyText], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `sip-chat-history-${new Date().toISOString()}.txt`;
      a.click();
    }

    function enforceSectionHeaders() {
      const input = document.getElementById('input');
      const textToAdd = " The only sections should be summary, background, motivation, specification, benefits, drawbacks, and implementation.";
      input.value += textToAdd;
      input.focus();
    }

    function askForPrettyText() {
      const input = document.getElementById('input');
      const textToAdd = " Please provide the response as formatted text";
      input.value += textToAdd;
      input.focus();
    }

    function askForMarkdown() {
      const input = document.getElementById('input');
      const textToAdd = " Please provide the response as raw markdown";
      input.value += textToAdd;
      input.focus();
    }
  </script>
</body>
</html> 